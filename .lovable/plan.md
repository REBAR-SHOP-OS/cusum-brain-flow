

## رفع مشکل: حذف ساعت از کپشن + انتقال صحیح کپشن به Social Media Post

### مشکل‌های فعلی
1. کپشن تولید شده توسط Pixel شامل اطلاعات ساعت اسلات (مثلاً "06:30 AM") و هدرهای قالبی (`Slot 1 — 06:30 AM | Rebar Stirrups`) می‌شود
2. بعد از تایید (Approve)، کپشن تمیز نمی‌شود و اطلاعات اضافی مثل ساعت و عنوان اسلات هم در `social_posts` ذخیره می‌شود
3. در پنل Social Media Post، محتوای نمایش داده شده شامل اطلاعات غیرضروری است

### راه‌حل

#### ۱. فایل: `supabase/functions/ai-agent/index.ts` — حذف ساعت از خروجی Pixel
در بخش ساخت خروجی (خطوط ~571-589)، هدر اسلات را بدون ساعت بسازیم:

**قبل:**
```text
`### Slot ${slot.slot} — ${slot.time} | ${slot.product}`
```

**بعد:**
```text
`### Slot ${slot.slot} — ${slot.product}`
```

این تغییر باعث می‌شود ساعت اصلاً در متن خروجی وجود نداشته باشد.

#### ۲. فایل: `src/pages/AgentWorkspace.tsx` — بهبود پاکسازی کپشن در `handleApprovePost`
تابع `handleApprovePost` باید کپشن را به طور کامل تمیز کند:

- حذف هدرهای Slot (با یا بدون ساعت): `### Slot 1 — 06:30 AM | Rebar Stirrups` یا `### Slot 1 — Rebar Stirrups`
- حذف لیبل‌های `**Caption:**` و `**Hashtags:**`
- حذف خطوط هشتگ
- حذف اطلاعات تماس (آدرس، تلفن، وبسایت) از کپشن — چون اینها جداگانه مدیریت می‌شوند
- حذف بخش Persian translation (`---PERSIAN---`)
- نگه داشتن فقط متن تبلیغاتی خالص

**منطق جدید پاکسازی:**
```text
cleanCaption:
1. حذف بخش ---PERSIAN--- و هرچه بعدش هست
2. حذف هدرهای ### Slot ...
3. حذف ![alt](url) تصاویر
4. حذف **Caption:** و **Hashtags:**
5. حذف خطوطی که فقط هشتگ دارند
6. حذف PIXEL_CONTACT_INFO خطوط (آدرس/تلفن/وبسایت)
7. trim نهایی
```

**تنظیم `title`:** از اولین جمله تبلیغاتی (حداکثر 50 کاراکتر)
**تنظیم `content`:** کل متن تبلیغاتی تمیز شده (بدون ساعت، بدون هدر، بدون اطلاعات تماس)

#### ۳. فایل: `src/components/social/PixelChatRenderer.tsx` — بهبود `extractPostData`
تابع `extractPostData` هم باید بهتر ساعت و هدرها را پاک کند تا در کارت‌های نمایشی Pixel هم ساعت دیده نشود:

- Regex هدر اسلات را بهبود بده تا شامل ساعت هم باشد: `/^#{1,4}\s*Slot\s*\d+\s*[—\-]\s*(\d{1,2}:\d{2}\s*(AM|PM)\s*\|?\s*)?.*/gm`
- خطوط اطلاعات تماس را هم حذف کن

### فایل‌های تغییریافته

| فایل | تغییر |
|------|-------|
| `supabase/functions/ai-agent/index.ts` | حذف ساعت از هدر خروجی Pixel |
| `src/pages/AgentWorkspace.tsx` | پاکسازی کامل کپشن هنگام approve (بدون ساعت، بدون هدر، بدون اطلاعات تماس) |
| `src/components/social/PixelChatRenderer.tsx` | بهبود regex حذف هدر اسلات (شامل ساعت) |

### نتیجه
- کپشن در کارت‌های Pixel: فقط متن تبلیغاتی + هشتگ
- کپشن در Social Media Post بعد از تایید: فقط متن تبلیغاتی خالص بدون ساعت، هدر، یا اطلاعات اضافی
- هشتگ‌ها جداگانه ذخیره و نمایش داده می‌شوند

