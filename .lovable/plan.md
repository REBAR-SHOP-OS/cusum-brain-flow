
هدف: رفع ریشه‌ای مشکل Pixel تا با انتخاب اسلات، واقعاً تصویر ساخته شود (نه متن placeholder)، تصویر قبل از کپشن نمایش داده شود، و لوگوی فایل شرکت همیشه در ساخت تصویر لحاظ شود.

یافته‌های قطعی از کد فعلی:
1) گارد تولید تصویر در جای اشتباه قرار گرفته:
- در `supabase/functions/ai-agent/index.ts` منطق Step 2 (اسلات 1-5/all) داخل بلاک `if (agent === "estimation" && attachedFiles.length > 0)` افتاده است.
- نتیجه: برای `agent === "social"` اصلاً اجرا نمی‌شود و کنترل دوباره به LLM می‌رسد.
- همین باعث پاسخ‌های متنی بی‌ربط مثل `[Image of ...]` شده است.

2) حتی اگر آن گارد اجرا شود، خروجی هنوز ممکن است عکس واقعی نباشد:
- `generatePixelImage` فعلی تابع `generate-image` را صدا می‌زند که اغلب `data:image...` برمی‌گرداند.
- سپس در پاسخ، به‌جای رندر تصویر واقعی، placeholder متنی قرار داده می‌شود (`[Image generated — base64 ...]`).

3) الزام لوگو به‌صورت «فایل واقعی لوگو» enforce نشده:
- الان فقط متن prompt درباره logo هست، اما فایل لوگو به‌صورت ورودی تصویری تضمین‌شده به مدل داده نمی‌شود.
- ضمن اینکه URL لوگو در knowledge به‌صورت signed URL ذخیره شده و ممکن است منقضی شود.

4) یک ناسازگاری محتوایی هم وجود دارد:
- شماره تماس hardcoded فعلی در `ai-agent/index.ts` با مقدار موردنیاز شما یکسان نیست.

راه‌حل ریشه‌ای (قطعی و قابل اتکا):
A) جابه‌جایی و بازطراحی Deterministic Guardrail برای Pixel (Step 2)
فایل: `supabase/functions/ai-agent/index.ts`
- منطق تشخیص اسلات را از بلاک estimation خارج می‌کنیم و کنار Guardrail فعلی Step 1 قرار می‌دهیم (قبل از callAI).
- این Guardrail فقط برای `agent === "social"` فعال می‌شود و ورودی‌های زیر را قطعی هندل می‌کند:
  - عدد 1 تا 5
  - زمان‌های 06:30, 07:30, 08:00, 12:30, 14:30 (و فرمت‌های AM/PM)
  - `all`
- نتیجه: دیگر تصمیم به tool-call به LLM واگذار نمی‌شود؛ با انتخاب اسلات، مستقیم تولید تصویر اجرا می‌شود.

B) تضمین «تصویر واقعی + URL قابل نمایش» (بدون placeholder)
فایل: `supabase/functions/ai-agent/index.ts`
- helper تولید تصویر به‌جای اتکا به مسیر فعلی، خروجی را همیشه به URL قابل‌نمایش تبدیل می‌کند:
  1. تولید تصویر با مدل تصویری
  2. اگر خروجی base64 بود، همان‌جا آپلود در `social-images`
  3. برگشت `publicUrl` نهایی
- در خروجی نهایی Pixel:
  - خط اول: markdown image واقعی `![...](https://.../social-images/...)`
  - خط بعد: caption
  - سپس contact info و hashtags
- این ترتیب دقیقاً نیاز شما را enforce می‌کند: «اول عکس، بعد کپشن».

C) enforce واقعی استفاده از فایل لوگو در تصویر
فایل: `supabase/functions/ai-agent/index.ts` (و در صورت نیاز هم‌راستا در `agentToolExecutor.ts`)
- قبل از تولید تصویر، جدیدترین فایل لوگوی Pixel از knowledge خوانده می‌شود (`metadata.agent = "social"` و نوع تصویر).
- URL لوگو پایدار می‌شود:
  - اگر public URL قابل ساخت باشد، URL عمومی بدون انقضا ساخته می‌شود.
  - در غیر این صورت signed URL جدید کوتاه‌عمر تولید می‌شود.
- درخواست تولید تصویر به مدل به‌صورت چندبخشی ارسال می‌شود تا لوگو واقعاً ورودی تصویر باشد (نه صرفاً متن):
  - متن دستور
  - image_url لوگوی شرکت
- این کار «استفاده از فایل لوگوی شرکت» را از حالت توصیه‌ای به حالت اجرایی نزدیک می‌کند.

D) هم‌راستاسازی لایه ابزار برای جلوگیری از drift
فایل: `supabase/functions/_shared/agentToolExecutor.ts`
- مسیر `generate_image` با همان استاندارد بالا هم‌راستا می‌شود (logo-aware + upload + public URL).
- این باعث می‌شود چه مسیر deterministic اجرا شود چه tool route، خروجی رفتار یکسان داشته باشد.

E) سخت‌گیرتر کردن دستورهای Pixel برای جلوگیری از خروجی نمایشی/جعلی
فایل: `supabase/functions/_shared/agents/marketing.ts`
- یک قاعده صریح اضافه می‌شود:
  - تولید متن placeholder مانند `[Image of ...]` ممنوع.
  - اگر URL تصویر واقعی نداریم، باید خطای فنی شفاف بدهد.
- همچنین تماس و قالب کپشن دقیقاً با الزامات شما یکسان می‌شود.

F) اصلاح ناسازگاری اطلاعات تماس
فایل: `supabase/functions/ai-agent/index.ts`
- شماره و قالب contact info با مقادیر الزامی شما یکسان‌سازی می‌شود تا کپشن‌ها همیشه درست باشند.

تست پذیرش (End-to-End) که اجرا خواهد شد:
1) `/agent/social` → New chat
- باید جدول برنامه بیاید (مثل قبل، بدون عذرخواهی).

2) ارسال `1`
- باید فوراً تصویر واقعی تولید شود.
- در پاسخ، تصویر باید بالای متن نمایش داده شود.
- زیر تصویر کپشن + اطلاعات تماس + هشتگ بیاید.

3) ارسال زمان (مثل `06:30` یا `2:30 PM`)
- باید همان اسلات درست resolve و تصویر تولید شود.

4) ارسال `all`
- باید 5 تصویر واقعی (هرکدام با کپشن خودش) تولید شود.

5) بررسی لوگو
- در prompt و payload تولید تصویر، لوگوی فایل شرکت به‌عنوان ورودی تصویر وجود داشته باشد.
- خروجی تصویری فاقد لوگو نباشد (تا حد توان مدل و با enforce قوی در ورودی).

6) بررسی regression
- ایجنت‌های غیر Pixel هیچ تغییر رفتاری نداشته باشند.

فایل‌هایی که تغییر می‌کنند:
- `supabase/functions/ai-agent/index.ts` (اصلی‌ترین اصلاح ریشه‌ای)
- `supabase/functions/_shared/agentToolExecutor.ts` (هم‌راستاسازی مسیر ابزار)
- `supabase/functions/_shared/agents/marketing.ts` (تقویت قوانین خروجی Pixel)

تغییرات دیتابیس:
- نیاز به مهاجرت دیتابیس ندارد.
- فقط خواندن داده knowledge و استفاده از storage URL انجام می‌شود.

ریسک‌ها و کنترل:
- ریسک: تشخیص اشتباه اسلات از پیام‌های مبهم
  - کنترل: parser دقیق با اولویت عدد/زمان مشخص و fallback امن.
- ریسک: منقضی شدن URL لوگو
  - کنترل: تولید URL پایدار (public) یا signed URL تازه در لحظه.
- ریسک: مدل گاهی لوگو را کمرنگ اعمال کند
  - کنترل: ارسال لوگو به‌عنوان ورودی تصویری + prompt سخت‌گیرانه + مسیر deterministic.
