
تشخیص دقیق مشکل (علت اصلی):

- مشکل از خود مدل نیست؛ از ورودی لوگو به مدل است.
- در بک‌اند، `resolveLogoUrl` الان فقط این مسیر ثابت را می‌سازد:
  `.../storage/v1/object/public/social-images/brand/company-logo.png`
- این فایل در فضای فایل بک‌اند وجود ندارد (404).  
  نتیجه: وقتی مدل تصویر با `image_url` نامعتبر فراخوانی می‌شود، درخواست 400 برمی‌گردد و همه attemptها fail می‌شوند.
- شواهد بررسی:
  - خروجی درخواست `/functions/v1/ai-agent` برای Slot 1:  
    `All generation attempts failed. Last: google/gemini-3-pro-image-preview returned 400`
  - بررسی آبجکت‌های bucket `social-images`: فقط فایل‌های `pixel/...` وجود دارد و هیچ `brand/company-logo.png` ثبت نشده.
  - تست URL لوگو: پاسخ `Object not found (404)`.

آنچه باید اصلاح شود تا «دقیقاً مثل قبل» کار کند و فقط لوگوی شرکت شما استفاده شود:

1) تثبیت منبع لوگوی رسمی (یک منبع یکتا)
- لوگوی آپلودی شما به‌عنوان تنها لوگوی مجاز در مسیر ثابت زیر ذخیره شود:
  `social-images/brand/company-logo.png`
- این مسیر به‌عنوان Source of Truth نهایی باقی بماند.

2) سخت‌گیری در `resolveLogoUrl` با preflight واقعی
- قبل از ارسال به مدل، روی URL لوگو `HEAD` زده شود:
  - اگر 200 بود: ادامه تولید تصویر با همین لوگو.
  - اگر 404/خطا بود: اصلاً مدل صدا زده نشود و خطای شفاف برگردد (نه 400 مبهم مدل).
- این کار هم پایداری را بالا می‌برد هم دیباگ را روشن می‌کند.

3) ممنوعیت کامل لوگوی جایگزین
- هیچ fallback به لوگوی دیگر، متن واترمارک، یا بازتولید لوگو نداشته باشیم.
- فقط همین لوگوی رسمی شما با دستور الزام‌آور فعلی استفاده شود (بدون تغییر در شکل، رنگ، نسبت، یا بازطراحی).

4) حفظ رفتار قبلی تولید Pixel
- همان جریان deterministic slot generation حفظ می‌شود.
- فقط لایه لوگو اصلاح می‌شود تا خروجی دوباره مثل قبل پایدار تولید شود.
- ترجمه فارسی و ساختار خروجی فعلی دست‌نخورده می‌ماند.

5) بهبود پیام خطا برای کاربر
- اگر لوگو موجود نبود، پیام دقیق برگردانده شود مثل:
  «لوگوی رسمی شرکت در مخزن برند پیدا نشد؛ لطفاً همگام‌سازی لوگو انجام شود.»
- این باعث می‌شود کاربر به‌جای خطای کلی 400، علت واقعی را ببیند.

6) راستی‌آزمایی نهایی (E2E)
- تست 1: ارسال Slot 1 در `/agent/social` → تصویر باید موفق تولید شود.
- تست 2: بررسی تصویر خروجی → فقط لوگوی رسمی شرکت شما وجود داشته باشد.
- تست 3: چند بار Regenerate → همچنان فقط همان لوگو و بدون لوگوی جایگزین.
- تست 4: در صورت حذف فایل لوگو از مسیر ثابت → خطای شفاف «logo missing» نمایش داده شود (نه 400 مبهم مدل).

فایل‌هایی که در اجرا باید تغییر کنند:
- `supabase/functions/ai-agent/index.ts`
  - اعتبارسنجی موجودبودن لوگو (HEAD check)
  - قطع تماس مدل وقتی لوگو در دسترس نیست
  - پیام خطای دقیق و الزام عدم fallback به لوگوی دیگر

خلاصه:
مشکل فعلی به‌دلیل نبودن فایل لوگو در مسیر ثابت بک‌اند است، نه به‌خاطر خود تولید تصویر. با تثبیت فایل لوگو در مسیر canonical و اضافه‌کردن preflight check، تولید تصویر به حالت پایدار «مثل قبل» برمی‌گردد و قاعده «فقط لوگوی شرکت شما» به‌صورت سخت‌گیرانه اجرا می‌شود.
