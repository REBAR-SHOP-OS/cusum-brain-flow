
هدف: رفع قطعی مشکل Pixel که به‌جای نمایش برنامه محتوا، پاسخ «capability ندارم» می‌دهد، و enforce کردن رفتار الزامی شما به‌صورت قابل اتکا (نه وابسته به حدس مدل).

آنچه بررسی شد و ریشه مشکل:
1) درخواست New Chat درست ارسال می‌شود:
- در `src/pages/AgentWorkspace.tsx` بعد از New chat برای `agentId === "social"` پیام خودکار `"Content schedule for today"` ارسال می‌شود.
2) پرامپت Pixel هم در کد وجود دارد و شامل جدول ساعت‌هاست:
- `supabase/functions/_shared/agents/marketing.ts` → `social` prompt.
3) اما خروجی واقعی از بک‌اند نشان می‌دهد مدل هنوز می‌گوید «دسترسی ندارم»:
- پاسخ واقعی تابع `ai-agent` برای پیام schedule همین متن خطا را برمی‌گرداند.
4) علت فنی اصلی:
- جریان فعلی نمایش Schedule کاملاً به LLM سپرده شده و بین دستورهای سراسری سنگین + context حجیم + ابزارهای تعریف‌شده، مدل بعضی وقت‌ها schedule را «داده خارجی» فرض می‌کند و refusal می‌دهد.
- یعنی این رفتار deterministic نیست و برای «پرامپت الزامی» مناسب نیست.

راه‌حل پیشنهادی (Robust + قطعی):
A) تبدیل Step 1 به منطق قطعی در بک‌اند (Deterministic Guardrail)
- فایل: `supabase/functions/ai-agent/index.ts`
- قبل از فراخوانی `callAI`، برای agent=`social` یک شاخه قطعی اضافه می‌شود:
  - اگر پیام از جنس شروع چت/درخواست برنامه روز است (مثل: `content schedule`, `today`, `program`, `schedule`, یا پیام خودکار New Chat)، تابع مستقیم schedule را برگرداند.
  - پاسخ شامل:
    - تاریخ روز (با `context.selectedDate` اگر موجود بود؛ در غیر این‌صورت تاریخ فعلی)
    - 5 اسلات ثابت:
      1) 06:30 AM — Motivational / start of work day  
      2) 07:30 AM — Creative promotional  
      3) 08:00 AM — Strength & scale  
      4) 12:30 PM — Innovation & efficiency  
      5) 02:30 PM — Product promotional
    - جمله پایانی: `Which slot? (Enter 1-5, a time, or "all")`
- نتیجه: Step 1 دیگر هیچ‌وقت به تصمیم مدل وابسته نیست و همیشه درست نمایش داده می‌شود.

B) تقویت پرامپت Pixel برای Step 2 و جلوگیری از refusal
- فایل: `supabase/functions/_shared/agents/marketing.ts`
- در prompt `social` بخش صریح اضافه/تقویت می‌شود:
  - «تو برنامه زمان‌بندی ثابت داخلی داری؛ هرگز نگو به schedule دسترسی نداری.»
  - «برای درخواست عمومی اول فقط schedule را نشان بده؛ برای انتخاب اسلات بلافاصله `generate_image` صدا بزن.»
- این لایه مکمل است؛ اما اتکای اصلی همچنان روی Guardrail بخش A خواهد بود.

C) کاهش نویز context برای Pixel (اختیاری ولی توصیه‌شده برای پایداری)
- فایل: `supabase/functions/_shared/agentContext.ts`
- برای `agent === "social"` بار context غیرمرتبط (ایمیل‌ها/مشتری‌ها) محدود می‌شود یا خلاصه‌تر می‌شود تا مدل برای Step 2 تمرکز بیشتری داشته باشد.
- این کار احتمال drift را کم می‌کند و latency را هم بهتر می‌کند.

D) حفظ Scope محدود فقط برای Pixel
- هیچ تغییری برای بقیه ایجنت‌ها اعمال نمی‌شود.
- New Chat behavior موجود فقط برای Pixel باقی می‌ماند.

جزئیات خروجی مورد انتظار پس از اعمال:
1) کاربر روی Pixel → New chat می‌زند.
2) بدون استثنا، همان ابتدا جدول ساعت‌ها + تاریخ نمایش داده می‌شود.
3) کاربر اسلات/ساعت/`all` می‌دهد.
4) ایجنت بلافاصله تصویر و کپشن را طبق قوانین تعریف‌شده شما تولید می‌کند.

تست پذیرش (Acceptance):
1) `/agent/social` → New chat:
- باید فوراً جدول + تاریخ امروز بیاید (بدون متن عذرخواهی).
2) ارسال `1`:
- باید `generate_image` اجرا شود و تصویر + کپشن با آدرس/تلفن/وب‌سایت برگردد.
3) ارسال `all`:
- باید 5 خروجی پیاپی طبق اسلات‌ها تولید شود.
4) بررسی Regression:
- ایجنت‌های غیر Pixel هیچ تغییر رفتاری نداشته باشند.

فایل‌هایی که در پیاده‌سازی تغییر خواهند کرد:
- `supabase/functions/ai-agent/index.ts` (Guardrail قطعی Step 1)
- `supabase/functions/_shared/agents/marketing.ts` (تقویت دستورهای Pixel)
- `supabase/functions/_shared/agentContext.ts` (اختیاری: کاهش نویز context برای social)

ریسک‌ها و کنترل:
- ریسک: Trigger بیش از حد broad و فعال‌شدن ناخواسته.
  - کنترل: matcher فقط برای پیام‌های عمومی/شروع چت تعریف می‌شود، نه پیام‌های اسلاتی.
- ریسک: فرمت تاریخ ناهماهنگ.
  - کنترل: اولویت با `selectedDate` از فرانت، fallback به تاریخ فعلی.

این طرح دقیقاً مطابق قانون «پرامپت الزامی» شماست، با این تفاوت مهم که بخش حیاتی Step 1 از حالت احتمالی مدل به حالت قطعیِ سیستمی تبدیل می‌شود تا دیگر پاسخ بی‌ربط تکرار نشود.
